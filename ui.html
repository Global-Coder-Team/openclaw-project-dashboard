<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenClaw Project Dashboard</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --line: rgba(255,255,255,0.10);
      --good: #39d98a;
      --warn: #ffcc66;
      --bad: #ff5c7a;
      --accent: #78a6ff;
      --shadow: 0 20px 60px rgba(0,0,0,0.55);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 15% 20%, rgba(120,166,255,0.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 10%, rgba(57,217,138,0.12), transparent 50%),
                  radial-gradient(1000px 700px at 70% 80%, rgba(255,92,122,0.10), transparent 55%),
                  var(--bg);
      min-height: 100vh;
    }
    header { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px); background: rgba(11,16,32,0.75); border-bottom: 1px solid var(--line); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 14px 16px; }
    h1 { margin: 0; font-size: 16px; letter-spacing: 0.2px; }
    .subtitle { font-size: 12px; color: var(--muted); }
    main { max-width: 1200px; margin: 0 auto; padding: 16px; display: grid; grid-template-columns: 380px 1fr; gap: 14px; }
    @media (max-width: 960px) { main { grid-template-columns: 1fr; } }
    .card { border: 1px solid var(--line); background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.03)); border-radius: 14px; box-shadow: var(--shadow); overflow: hidden; }
    .cardHeader { padding: 10px 12px; border-bottom: 1px solid var(--line); display: flex; align-items: center; justify-content: space-between; }
    .cardBody { padding: 12px; }
    .muted { color: var(--muted); font-size: 12px; }
    .list { display: grid; gap: 8px; }
    .item { border: 1px solid var(--line); background: rgba(255,255,255,0.04); border-radius: 12px; padding: 10px; display: grid; gap: 4px; }
    .itemTop { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .itemTitle { font-weight: 700; font-size: 13px; }
    .badge { font-size: 11px; color: var(--muted); border: 1px solid var(--line); padding: 3px 8px; border-radius: 999px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    input, select, textarea, button { width: 100%; padding: 9px 10px; border-radius: 10px; border: 1px solid var(--line); background: rgba(0,0,0,0.18); color: var(--text); outline: none; }
    textarea { min-height: 80px; }
    button { cursor: pointer; background: linear-gradient(180deg, rgba(120,166,255,0.35), rgba(120,166,255,0.18)); border: 1px solid rgba(120,166,255,0.45); font-weight: 650; }
    button.secondary { background: rgba(255,255,255,0.05); border-color: var(--line); font-weight: 600; }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .tab { padding: 7px 10px; border-radius: 999px; border:1px solid var(--line); background: rgba(255,255,255,0.05); color: var(--muted); cursor:pointer; font-size: 12px; }
    .tab.active { border-color: rgba(120,166,255,0.55); color: var(--text); background: rgba(120,166,255,0.14); }
    .statusDot { width: 9px; height: 9px; border-radius: 999px; display:inline-block; margin-right: 8px; }
    .dot-green { background: var(--good); }
    .dot-yellow { background: var(--warn); }
    .dot-red { background: var(--bad); }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 9px; border-radius:999px; border:1px solid var(--line); background: var(--panel); font-size:12px; color: var(--muted); }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .row { display:flex; align-items:center; gap:8px; }
    .small { font-size:12px; color:var(--muted); }
    .section { margin-bottom: 8px; }
    .sectionHeader { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; cursor: pointer; user-select: none; border-radius: 10px; background: rgba(255,255,255,0.03); }
    .sectionHeader:hover { background: rgba(255,255,255,0.06); }
    .sectionTitle { font-weight: 700; font-size: 13px; }
    .sectionBody { padding: 8px 0; }
    .sectionBody.collapsed { display: none; }
    .chevron { transition: transform 0.2s; font-size: 11px; color: var(--muted); }
    .chevron.open { transform: rotate(90deg); }
    .source-badge { font-size: 10px; padding: 2px 6px; border-radius: 999px; font-weight: 600; }
    .source-human { background: rgba(120,166,255,0.2); color: var(--accent); }
    .source-agent { background: rgba(57,217,138,0.2); color: var(--good); }
    .health-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .health-green { background: var(--good); }
    .health-yellow { background: var(--warn); }
    .health-red { background: var(--bad); }
    .queue-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px solid var(--line); border-radius: 10px; background: rgba(255,255,255,0.03); cursor: grab; }
    .queue-item.active { border-color: rgba(57,217,138,0.4); background: rgba(57,217,138,0.08); }
    .queue-rank { font-size: 11px; color: var(--muted); min-width: 18px; text-align: center; }
    .queue-text { flex: 1; font-size: 12px; }
    .queue-project { font-size: 10px; color: var(--accent); }
    .queue-actions { display: flex; gap: 4px; }
    .queue-actions button { width: auto; padding: 3px 7px; font-size: 10px; }
    .activity-item { display: flex; gap: 8px; align-items: flex-start; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 12px; }
    .activity-time { color: var(--muted); font-size: 11px; min-width: 40px; }
    .pulse-dot { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    .offline-badge { color: var(--bad); font-size: 11px; display: none; }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div>
        <h1>Project Dashboard</h1>
        <div class="subtitle">Manual-first. Local-first. Shows what’s moving right now.</div>
      </div>
      <div class="pill"><span class="mono" id="dbMeta">DB</span> <span id="nowMeta"></span></div>
    </div>
  </header>

  <main>
    <section class="card" style="overflow-y:auto; max-height: calc(100vh - 80px);">
      <div class="cardHeader">
        <div style="font-weight:700;">Command Center</div>
        <div class="row" style="gap:6px;">
          <span class="offline-badge" id="offlineBadge">offline</span>
          <button class="secondary" id="btnRefresh" style="width:auto;">Refresh</button>
        </div>
      </div>
      <div class="cardBody" style="padding:8px;">

        <!-- Work Queue Section -->
        <div class="section" id="sectionQueue">
          <div class="sectionHeader" data-section="queue">
            <div class="sectionTitle">Work Queue <span class="badge" id="queueCount">0</span></div>
            <span class="chevron open" id="chevronQueue">&#9654;</span>
          </div>
          <div class="sectionBody" id="bodyQueue">
            <div style="display:flex; gap:6px; margin-bottom:8px;">
              <input id="queueInput" placeholder="Add instruction..." style="flex:1;" />
              <button id="btnAddQueue" style="width:auto; padding:6px 10px;">Add</button>
            </div>
            <div id="queueList" class="list" style="gap:6px;"></div>
          </div>
        </div>

        <!-- Cron Health Section -->
        <div class="section" id="sectionCron">
          <div class="sectionHeader" data-section="cron">
            <div class="sectionTitle">Cron Health <span class="badge" id="cronCount">0</span></div>
            <span class="chevron open" id="chevronCron">&#9654;</span>
          </div>
          <div class="sectionBody" id="bodyCron">
            <div id="cronList" class="list" style="gap:6px;"></div>
          </div>
        </div>

        <!-- Activity Feed Section -->
        <div class="section" id="sectionActivity">
          <div class="sectionHeader" data-section="activity">
            <div class="sectionTitle">Activity Feed</div>
            <span class="chevron open" id="chevronActivity">&#9654;</span>
          </div>
          <div class="sectionBody" id="bodyActivity">
            <div id="activityList"></div>
          </div>
        </div>

        <!-- Projects list (compact, below activity) -->
        <div class="section" id="sectionProjects">
          <div class="sectionHeader" data-section="projects">
            <div class="sectionTitle">Projects <span class="badge" id="projectCount">0</span></div>
            <span class="chevron open" id="chevronProjects">&#9654;</span>
          </div>
          <div class="sectionBody" id="bodyProjects">
            <div class="list" id="projectsList"></div>
          </div>
        </div>

      </div>
    </section>

    <section class="card" id="detailCard">
      <div class="cardHeader" style="gap:8px; flex-wrap:wrap;">
        <div>
          <div id="projTitle" style="font-weight:700;"></div>
          <div class="row" style="gap:6px; flex-wrap:wrap;">
            <span class="pill" id="projStatus"></span>
            <span class="pill" id="projActive" style="display:none; background: rgba(57,217,138,0.18); border-color: rgba(57,217,138,0.5); color: #39d98a;"></span>
          </div>
        </div>
      </div>
      <div class="cardBody">
        <div class="tabs" id="detailTabs">
          <div class="tab active" data-tab="dashboard">Dashboard</div>
          <div class="tab" data-tab="overview">Overview</div>
          <div class="tab" data-tab="tasks">Tasks</div>
          <div class="tab" data-tab="schedules">Schedules</div>
          <div class="tab" data-tab="strategy">Strategy</div>
          <div class="tab" data-tab="updates">Updates</div>
        </div>

        <div id="view_dashboard" class="stack" style="margin-top:10px; display:grid; gap:10px;"></div>
        <div id="view_overview" class="stack" style="margin-top:10px; display:none; gap:10px;"></div>
        <div id="view_tasks" style="display:none; margin-top:10px; display:grid; gap:10px;"></div>
        <div id="view_schedules" style="display:none; margin-top:10px; display:grid; gap:10px;"></div>
        <div id="view_strategy" style="display:none; margin-top:10px; display:grid; gap:10px;"></div>
        <div id="view_updates" style="display:none; margin-top:10px; display:grid; gap:10px;"></div>
      </div>
    </section>
  </main>

<script>
let STATE = null;
let selectedId = null;
const el = (id) => document.getElementById(id);

function statusDot(status){
  const cls = status === 'red' ? 'dot-red' : status === 'yellow' ? 'dot-yellow' : 'dot-green';
  return `<span class="statusDot ${cls}"></span>`;
}

function fmtAge(ms){
  if (ms < 60_000) return `${Math.floor(ms/1000)}s`;
  if (ms < 3_600_000) return `${Math.floor(ms/60_000)}m`;
  if (ms < 86_400_000) return `${Math.floor(ms/3_600_000)}h`;
  return `${Math.floor(ms/86_400_000)}d`;
}
function fmtTime(ts){ if(!ts) return '—'; return new Date(ts).toLocaleString(); }

async function api(path, body) {
  const res = await fetch(path, body ? {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(body)
  } : {});
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}

async function refresh(){
  const data = await api('/api/state');
  STATE = data;
  el('dbMeta').textContent = 'SQLite';
  el('nowMeta').textContent = new Date().toLocaleTimeString();
  renderProjects();
  if (!selectedId && data.projects.length) selectedId = data.projects[0].id;
  renderDetail();
}

function activeFor(projectId){
  const now = Date.now();
  const upd = (STATE?.recentUpdates||[]).find(u => u.projectId===projectId && (now - u.createdAt) <= 10*60*1000);
  const taskBlock = (STATE?.tasks||[]).find(t => t.projectId===projectId);
  const doing = (taskBlock?.items||[]).find(t => t.status==='doing' && (now - t.updatedAt)<=30*60*1000);
  const schedule = (STATE?.schedules||[]).find(s => s.projectId===projectId && s.lastAt);
  const reasons = [];
  if (upd) reasons.push(`Recent update ${fmtAge(now - upd.createdAt)} ago`);
  if (doing) reasons.push(`Task in progress: ${doing.title}`);
  if (schedule) reasons.push(`Schedule last ran ${fmtAge(now - schedule.lastAt)} ago: ${schedule.jobName}`);
  return {active: reasons.length>0, reasons};
}

function renderProjects(){
  const list = el('projectsList');
  const projects = STATE.projects || [];
  el('projectCount').textContent = projects.length;
  list.innerHTML = projects.map(p => {
    const act = activeFor(p.id);
    return `<div class="item" data-id="${p.id}" style="cursor:pointer;">
      <div class="itemTop">
        <div class="itemTitle">${statusDot(p.status)}${escapeHtml(p.name)}</div>
        ${act.active ? `<span class='badge' style='color:#39d98a;border-color:rgba(57,217,138,0.4);background:rgba(57,217,138,0.15);'>Active</span>` : ''}
      </div>
    </div>`;
  }).join('');
  list.querySelectorAll('.item').forEach(div => {
    div.addEventListener('click', () => { selectedId = div.dataset.id; switchTab('overview'); renderDetail(); });
  });
}

function renderDetail(){
  const detail = el('detailCard');
  detail.style.display = '';

  if (currentTab === 'dashboard') {
    el('projTitle').textContent = 'Dashboard';
    el('projStatus').textContent = '';
    el('projActive').style.display = 'none';
    renderTab();
    return;
  }

  const proj = (STATE.projects||[]).find(p => p.id===selectedId);
  if (!proj){ detail.style.display='none'; return; }
  el('projTitle').textContent = proj.name;
  el('projStatus').textContent = `Status: ${proj.status}`;
  const act = activeFor(proj.id);
  if (act.active){ el('projActive').style.display='inline-flex'; el('projActive').textContent = act.reasons[0] || 'Active now'; } else { el('projActive').style.display='none'; }
  switchTab(currentTab);
}

let currentTab = 'dashboard';
function switchTab(tab){
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
  ['dashboard','overview','tasks','schedules','strategy','updates'].forEach(v => {
    el('view_' + v).style.display = v === tab ? '' : 'none';
  });
  renderTab();
}

document.getElementById('detailTabs').addEventListener('click',(e)=>{ const t=e.target.closest('.tab'); if(!t) return; switchTab(t.dataset.tab);} );

document.getElementById('btnRefresh').addEventListener('click', refresh);

document.querySelectorAll('.sectionHeader').forEach(header => {
  header.addEventListener('click', () => {
    const section = header.dataset.section;
    const body = document.getElementById('body' + section.charAt(0).toUpperCase() + section.slice(1));
    const chevron = document.getElementById('chevron' + section.charAt(0).toUpperCase() + section.slice(1));
    if (body) body.classList.toggle('collapsed');
    if (chevron) chevron.classList.toggle('open');
  });
});

function renderTab(){
  if (currentTab === 'dashboard') {
    const projects = STATE?.projects || [];
    const queue = STATE?.queue || [];
    const crons = STATE?.cronHealth || [];
    const activity = STATE?.activity || [];

    const green = projects.filter(p => p.status === 'green').length;
    const yellow = projects.filter(p => p.status === 'yellow').length;
    const red = projects.filter(p => p.status === 'red').length;
    const cronRed = crons.filter(c => c.health === 'red').length;
    const cronYellow = crons.filter(c => c.health === 'yellow').length;
    const inProgress = queue.find(q => q.status === 'in_progress');

    el('view_dashboard').innerHTML = `
      <div class="grid-2">
        <div class="item">
          <div class="itemTitle">Projects</div>
          <div class="row" style="gap:12px; margin-top:6px;">
            <span>${statusDot('green')} ${green} green</span>
            <span>${statusDot('yellow')} ${yellow} yellow</span>
            <span>${statusDot('red')} ${red} red</span>
          </div>
        </div>
        <div class="item">
          <div class="itemTitle">Work Queue</div>
          <div style="margin-top:6px; font-size:13px;">
            ${queue.length} pending${inProgress ? ` · <span style="color:var(--good);">Active: ${escapeHtml(inProgress.instruction.slice(0,50))}</span>` : ''}
          </div>
        </div>
        <div class="item">
          <div class="itemTitle">Cron Health</div>
          <div class="row" style="gap:12px; margin-top:6px;">
            <span><span class="health-dot health-green"></span>${crons.length - cronRed - cronYellow} healthy</span>
            ${cronYellow ? `<span><span class="health-dot health-yellow"></span>${cronYellow} stale</span>` : ''}
            ${cronRed ? `<span><span class="health-dot health-red"></span>${cronRed} failing</span>` : ''}
          </div>
        </div>
        <div class="item">
          <div class="itemTitle">Recent Activity</div>
          <div style="margin-top:6px;">
            ${activity.slice(0,5).map(a => `<div class="small">${fmtAge(Date.now()-a.createdAt)} · ${escapeHtml(a.action.replace(/_/g,' '))}${a.detail ? ': '+escapeHtml(a.detail.slice(0,60)) : ''}</div>`).join('') || '<div class="small">No activity</div>'}
          </div>
        </div>
      </div>
    `;
    return;
  }

  const proj = (STATE.projects||[]).find(p=>p.id===selectedId);
  if(!proj) return;
  const tasksBlock = (STATE.tasks||[]).find(t=>t.projectId===proj.id) || {items:[]};
  const schedules = (STATE.schedules||[]).filter(s=>s.projectId===proj.id);
  const updates = (STATE.recentUpdates||[]).filter(u=>u.projectId===proj.id).slice(0,10);

  if (currentTab==='overview'){
    el('view_overview').innerHTML = `
      <div class="item">
        <div class="itemTop"><div class="itemTitle">Objective</div></div>
        <div>${escapeHtml(proj.objective || 'Not set')}</div>
      </div>
      <div class="item">
        <div class="itemTop"><div class="itemTitle">Next Action</div></div>
        <div>${escapeHtml(proj.nextAction || 'Not set')}</div>
      </div>
      <div class="item">
        <div class="itemTop"><div class="itemTitle">Recent Activity</div></div>
        <div>${updates.map(u=>`<div class='small'>${escapeHtml(u.type)} · ${fmtAge(Date.now()-u.createdAt)} ago · ${escapeHtml(u.text)}</div>`).join('') || '<div class="small">No updates.</div>'}</div>
      </div>
    `;
  }

  if (currentTab==='tasks'){
    el('view_tasks').innerHTML = `
      <div class="item">
        <div class="itemTop"><div class="itemTitle">Add Task</div></div>
        <input id="newTaskTitle" placeholder="Task title" />
        <button id="btnAddTask">Add</button>
      </div>
      <div class="list">${tasksBlock.items.map(t => `
        <div class="item">
          <div class="itemTop">
            <div class="itemTitle">${escapeHtml(t.title)}</div>
            <div class="row" style="gap:6px;">
              <span class="badge">${t.status}</span>
              <button class="secondary" data-task="${t.id}" data-status="todo">todo</button>
              <button class="secondary" data-task="${t.id}" data-status="doing">doing</button>
              <button class="secondary" data-task="${t.id}" data-status="done">done</button>
            </div>
          </div>
          <div class="small">Updated ${fmtAge(Date.now()-t.updatedAt)} ago</div>
        </div>
      `).join('') || '<div class="item"><div class="small">No tasks yet.</div></div>'}</div>
    `;
    const addBtn = el('btnAddTask');
    if (addBtn) addBtn.onclick = async ()=>{
      const title = el('newTaskTitle').value.trim();
      if (!title) return;
      await api('/api/tasks', { projectId: proj.id, title });
      el('newTaskTitle').value='';
      await refresh();
      switchTab('tasks');
    };
    el('view_tasks').querySelectorAll('button[data-task]').forEach(btn=>{
      btn.onclick = async ()=>{
        const taskId = btn.dataset.task;
        const status = btn.dataset.status;
        await api('/api/tasks/update', { id: taskId, status });
        await refresh();
        switchTab('tasks');
      };
    });
  }

  if (currentTab==='schedules'){
    el('view_schedules').innerHTML = schedules.length ? schedules.map(s=>`
      <div class="item">
        <div class="itemTop"><div class="itemTitle">${escapeHtml(s.jobName)}</div><span class="badge">${escapeHtml(s.status||'')}</span></div>
        <div class="small">Last: ${fmtTime(s.lastAt)} | Next: ${fmtTime(s.nextAt)}</div>
      </div>
    `).join('') : '<div class="item"><div class="small">No schedules linked.</div></div>';
  }

  if (currentTab==='strategy'){
    el('view_strategy').innerHTML = `
      <div class="grid-2">
        <div class="item"><div class="itemTitle">Strategy</div><textarea id="fStrategy">${escapeHtml(proj.strategy||'')}</textarea></div>
        <div class="item"><div class="itemTitle">Hypothesis</div><textarea id="fHypothesis">${escapeHtml(proj.hypothesis||'')}</textarea></div>
        <div class="item"><div class="itemTitle">Constraints</div><textarea id="fConstraints">${escapeHtml(proj.constraints||'')}</textarea></div>
        <div class="item"><div class="itemTitle">Success looks like</div><textarea id="fSuccess">${escapeHtml(proj.success||'')}</textarea></div>
      </div>
      <button id="btnSaveStrategy">Save</button>
    `;
    const save = el('btnSaveStrategy');
    save.onclick = async ()=>{
      await api('/api/projects/update', {
        id: proj.id,
        strategy: el('fStrategy').value,
        hypothesis: el('fHypothesis').value,
        constraints: el('fConstraints').value,
        success: el('fSuccess').value,
      });
      await refresh();
      switchTab('strategy');
    };
  }

  if (currentTab==='updates'){
    el('view_updates').innerHTML = `
      <div class="item">
        <div class="itemTop"><div class="itemTitle">Add Update</div></div>
        <div class="grid-2">
          <select id="updateType">
            <option value="progress">progress</option>
            <option value="blocker">blocker</option>
            <option value="decision">decision</option>
            <option value="note">note</option>
            <option value="request">request</option>
          </select>
          <select id="statusHint">
            <option value="">status: (no change)</option>
            <option value="green">status: green</option>
            <option value="yellow">status: yellow</option>
            <option value="red">status: red</option>
          </select>
        </div>
        <textarea id="updateText" placeholder="One sentence: what changed, what’s next, or what’s blocked." ></textarea>
        <button id="btnAddUpdate">Add update</button>
      </div>
      <div class="list">${updates.map(u=>`
        <div class="item">
          <div class="itemTop"><div class="itemTitle">${escapeHtml(u.type)}</div><div class="badge">${fmtAge(Date.now()-u.createdAt)} ago</div></div>
          <div class="itemMeta">${escapeHtml(u.text)}</div>
        </div>
      `).join('') || '<div class="item"><div class="small">No updates yet.</div></div>'}</div>
    `;
    const btn = el('btnAddUpdate');
    if (btn) btn.onclick = async ()=>{
      const type = el('updateType').value;
      const text = el('updateText').value.trim();
      const status = el('statusHint').value;
      if (!text) return;
      await api('/api/updates', { projectId: proj.id, type, text, status: status || null });
      el('updateText').value='';
      el('statusHint').value='';
      await refresh();
      switchTab('updates');
    };
  }
}

function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

refresh().catch(err=>{
  console.error(err);
  alert('Failed to load: '+err.message);
});
</script>
</body>
</html>
